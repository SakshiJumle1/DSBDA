############## create database
CREATE DATABASE IF NOT EXISTS flight_db;
USE flight_db;

##################  Create Flight Information Table
CREATE TABLE IF NOT EXISTS flight_info (
    flight_id STRING,
    airline STRING,
    origin STRING,
    destination STRING,
    departure_time TIMESTAMP,
    arrival_time TIMESTAMP,
    departure_delay INT,
    arrival_delay INT,
    year INT,
    month INT,
    day INT
) 
ROW FORMAT DELIMITED 
FIELDS TERMINATED BY ','
STORED AS TEXTFILE;

############ drop table
DROP TABLE IF EXISTS flight_info;

#############3 alter table
ALTER TABLE flight_info ADD COLUMNS (carrier_delay INT, weather_delay INT);

#################Create External Hive Table
CREATE EXTERNAL TABLE IF NOT EXISTS external_flight_info (
    flight_id STRING,
    airline STRING,
    origin STRING,
    destination STRING,
    departure_time TIMESTAMP,
    arrival_time TIMESTAMP,
    departure_delay INT,
    arrival_delay INT,
    year INT,
    month INT,
    day INT
)
STORED AS TEXTFILE
LOCATION '/user/hive/warehouse/external_flight_data';

############## Load Data into Table
LOAD DATA INPATH '/user/hive/warehouse/flight_data.csv' INTO TABLE flight_info;

##############Insert New Values into Table
INSERT INTO TABLE flight_info
VALUES ('AA100', 'American Airlines', 'JFK', 'LAX', '2008-01-01 08:00:00', '2008-01-01 11:00:00', 30, 15, 2008, 1, 1);

############### Update Fields in Table
UPDATE flight_info
SET departure_delay = 45
WHERE flight_id = 'AA100';

################# Join Tables
-- Assuming we have another table for airline details
CREATE TABLE IF NOT EXISTS airline_info (
    airline STRING,
    airline_name STRING
);

-- Performing Join between flight_info and airline_info
SELECT f.flight_id, f.origin, f.destination, f.departure_delay, a.airline_name
FROM flight_info f
JOIN airline_info a
ON f.airline = a.airline;

############## Create Index on Flight Information Table
CREATE INDEX idx_flight_delay
ON TABLE flight_info (departure_delay)
AS 'org.apache.hadoop.hive.ql.index.compact.CompactIndexHandler';

############# Find the Average Departure Delay per Day in 2008
SELECT year, month, day, AVG(departure_delay) AS avg_departure_delay
FROM flight_info
WHERE year = 2008
GROUP BY year, month, day
ORDER BY year, month, day;

